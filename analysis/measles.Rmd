---
title: "Vaccination and delays in vaccination due to COVID-19"
author: "Duc Du, Thinh Ong"
date: ' 2020-01-29 (update: `r Sys.Date()`)'
output:
  html_document:
    theme: cerulean
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
  workflowr::wflow_html:
    toc: true
    theme: cosmo
  word_document:
    toc: yes
editor_options:
  chunk_output_type: inline
---

```{r}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, out.width = "100%")

library(data.table)
library(dplyr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(gtsummary)
library(ggsci)

datap <- file.path("~", "Downloads", "updated_dataset")

covidvc <- readRDS(file.path(datap, "Combined_VAC_COVID19_2022-02-17.rds"))
measle_all <- readRDS(file.path(datap, "measles_haiduong.rds"))
measle_all <- data.table(measle_all)

time_step <- "month"
```

```{r}
measle_all$vacym <- floor_date(measle_all$vacdate, time_step)
measle_all$vacname2 <- factor(measle_all$vacname2, levels = c("Measles", "MR", "MMR"))

measle_all <- measle_all %>%
  group_by(pid) %>%
  arrange(vacdate) %>%
  mutate(shot_any = 1:n()) %>%
  ungroup()

table(measle_all$shot_any)
table(measle_all$shot)
```


```{r}
covidvc <- covidvc[which(covidvc$location == "Hai Duong"),]
covidvc$total_shots <- rowSums(covidvc[,c("vaccinated_1st", "vaccinated_2nd", "vaccinated_3rd")], na.rm = T)

covidvc$vacym <- floor_date(covidvc$date, time_step)
covidvc$vacyear <- year(covidvc$vacym)
covidvc$vacmonth <- month(covidvc$vacym)

covid <- covidvc %>% 
  group_by(vacyear, vacmonth) %>%
  summarise(n = sum(total_shots))

covid$vacname2 <- "COVID vaccine"
covid$n <- covid$n / 50

df_plot <- measle_all %>% 
    count(vacyear, vacmonth, vacname2)

df_plot <- rbind(df_plot, covid)

ggplot(df_plot, aes(x = vacmonth, y = n, color = vacname2)) +
  geom_line(stat = "identity") +
  facet_wrap(~ vacyear) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 6)) +
  labs(x = NULL) +
  theme_light()
```

* High peak of MR shots in Nov 2019
* No disruption in Apr 2020
* Disruptions in Aug 2020 and Feb 2021

# Vaccination campaign in Nov 2019

An MR vaccination campaign is triggered during this time in Hai Duong, focusing on children 1-5 year-old
```{r}
tmp <- measle_all[which(measle_all$vacyear == "2019"),]

ggplot(tmp, aes(x = vagem)) +
  geom_histogram() +
  facet_wrap(~ vacmonth, scales = "free") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5)) +
  labs(x = "Age at vaccination (months)")
```

Distribution of delay
```{r}
ggplot(tmp, aes(x = vdelay)) +
  geom_histogram() +
  facet_wrap(~ vacmonth, scales = "free") +
  labs(x = "Delay (months)")
```

We have new variables informing whether a shot is given from a vaccination campaign
```{r}
table(measle_all$vactype)

df_plot <- measle_all %>% 
  count(vactype, vacname2) %>% 
  group_by(vactype) %>%
  mutate(prop = n / sum(n))

ggplot(df_plot, aes(x = vactype, y = prop, fill = vacname2)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis_d() +
  theme_light() +
  theme(legend.position = "bottom")
```


```{r}
table(measle_all$clinic_type)

df_plot <- measle_all %>% 
  count(clinic_type, vacname2) %>% 
  group_by(clinic_type) %>%
  mutate(prop = n / sum(n))

ggplot(df_plot, aes(x = clinic_type, y = prop, fill = vacname2)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis_d() +
  theme_light() +
  theme(legend.position = "bottom")
```

The proportion of campaign shots
```{r}
df_plot <- measle_all %>% 
  count(vacyear, vacmonth, vactype) %>% 
  group_by(vacyear, vacmonth) %>%
  mutate(prop = n / sum(n))
df_plot <- data.frame(df_plot)
df_plot <- df_plot %>% complete(vacyear, vacmonth, vactype, fill = list(n = 0, prop = 0))
ggplot(df_plot, aes(x = vacmonth, y = prop, fill = vactype)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ vacyear) +
  scale_fill_viridis_d() +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 6)) +
  theme_light() +
  theme(legend.position = "bottom")
```

```{r}
df_plot <- measle_all %>% 
  count(vacyear, vacmonth, clinic_type) %>% 
  group_by(vacyear, vacmonth) %>%
  mutate(prop = n / sum(n))
df_plot <- data.frame(df_plot)
df_plot <- df_plot %>% complete(vacyear, vacmonth, clinic_type, fill = list(n = 0, prop = 0))
ggplot(df_plot, aes(x = vacmonth, y = prop, fill = clinic_type)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ vacyear) +
  scale_fill_viridis_d() +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 6)) +
  theme_light() +
  theme(legend.position = "bottom")
```


# No disruption in Apr 2020

```{r}
df_plot <- measle_all %>% 
    count(vacyear, vacmonth, vacname2)

df_plot <- rbind(df_plot, covid)

ggplot(df_plot, aes(x = vacmonth, y = n, color = vacname2)) +
  geom_line(stat = "identity") +
  facet_wrap(~ vacyear) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 6)) +
  labs(x = NULL) +
  theme_light()
```

Zoom in 4/2020: The national lockdown was from 1/4 to 21/4. They compensate all the measles shots at 25/4 => no difference in delay
```{r}
tmp <- measle_all[which(measle_all$vacmonth == 4 & measle_all$vacyear == 2020),]

df_plot <- tmp %>% 
  count(vacdate, vacname2)

ggplot(df_plot, aes(x = vacdate, y = n, color = vacname2)) +
  geom_line(stat = "identity") +
  scale_x_date(date_breaks = "1 day", labels = scales::date_format("%d")) +
  labs(x = "Apr 2020") +
  theme_light()
```

# Disruptions in Aug 2020 and Feb 2021

```{r}
df_plot <- measle_all %>% 
    count(vacyear, vacmonth, vacname2)

df_plot <- rbind(df_plot, covid)

ggplot(df_plot, aes(x = vacmonth, y = n, color = vacname2)) +
  geom_line(stat = "identity") +
  facet_wrap(~ vacyear) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 6)) +
  labs(x = NULL) +
  theme_light()
```

## Zoom in 2020

The monthly vaccination date at public clinics is usually at the end of the month. In Mar 2020: right before lockdown they vaccinate children and right after lockdown they came back to vaccinate children

Hai Duong had a Hai Duong city-wide lockdown from 14/8-28/8, this time looks like they only organised the vaccination day in Sep so all children scheduled in Aug miss the shot
```{r}
tmp <- measle_all[which(measle_all$vacyear == 2020),]

df_plot <- tmp %>% 
    count(vacdate, vacname2)

ggplot(df_plot, aes(x = vacdate, y = n, color = vacname2)) +
  geom_rect(aes(xmin = ymd("2020-04-01"), xmax = ymd("2020-04-21"), ymin = -Inf, ymax = Inf), fill = "salmon2", color = NA, alpha = 0.015) +
  geom_rect(aes(xmin = ymd("2020-08-14"), xmax = ymd("2020-08-28"), ymin = -Inf, ymax = Inf), fill = "salmon2", color = NA, alpha = 0.015) +
  geom_line(stat = "identity") +
  scale_x_date(date_breaks = "1 month", labels = scales::date_format("%b")) +
  labs(x = NULL) +
  theme_light()
```

## Zoom in 2021

Hai Duong had a province-wide lockdown from 28/1/2021 - 15/2 (Directive 15), 16/2 - 2/3 (Directive 16), 3/3 - 17/3 (Directive 15), 18/3 - 31/3 (Directive 19)

Directive 16 > 15 > 19
```{r}
tmp <- measle_all[which(measle_all$vacyear == 2021),]

df_plot <- tmp %>% 
    count(vacdate, vacname2)

ggplot(df_plot, aes(x = vacdate, y = n, color = vacname2)) +
  geom_rect(aes(xmin = ymd("2021-01-28"), xmax = ymd("2021-02-15"), ymin = -Inf, ymax = Inf), fill = "lightpink", color = NA, alpha = 0.015) +
  geom_rect(aes(xmin = ymd("2021-02-16"), xmax = ymd("2021-03-02"), ymin = -Inf, ymax = Inf), fill = "salmon2", color = NA, alpha = 0.015) +
  geom_rect(aes(xmin = ymd("2021-03-03"), xmax = ymd("2021-03-17"), ymin = -Inf, ymax = Inf), fill = "lightpink", color = NA, alpha = 0.015) +
  geom_rect(aes(xmin = ymd("2021-03-18"), xmax = ymd("2021-03-31"), ymin = -Inf, ymax = Inf), fill = "grey90", color = NA, alpha = 0.025) +
  geom_line(stat = "identity") +
  scale_x_date(date_breaks = "1 month", labels = scales::date_format("%b")) +
  labs(x = NULL) +
  theme_light()
```

```{r}
measle_all$vacday <- day(measle_all$vacdate)

nday <- unique(measle_all$vacday)

ggplot(measle_all, aes(x = vacday)) +
  geom_histogram() +
  scale_x_continuous(breaks = nday) +
  labs(x = "Monthly day of vaccination") +
  theme_minimal()
```

