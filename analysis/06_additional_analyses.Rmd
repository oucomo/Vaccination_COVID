---
title: "Additional analyses"
author: "Duc Du, Thinh Ong"
date: ' `r Sys.Date()`'
output:
  workflowr::wflow_html:
    toc: true
    theme: cosmo
  pdf_document:
    toc: yes
  html_document:
    theme: cerulean
    toc: yes
    toc_float: yes
    keep_md: yes
  word_document:
    toc: yes
editor_options:
  chunk_output_type: inline
---

```{r}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cache.lazy = FALSE,
                      tidy.opts=list(width.cutoff=60),
                      tidy=TRUE,
                      root.dir = rprojroot::find_rstudio_root_file())

library(workflowr)
library(data.table)
library(tidyverse)
library(dplyr)
library(lubridate)
library(ggplot2)
library(gt)
library(gtsummary)
library(ggridges)
library(ggvenn)

select <- dplyr::select
allp <- file.path("~", "updated_dataset")
```

```{r}
# Get a vector of public provinces
dtadir <- file.path("~", "sharefolder", "data", "tuann349")
publicProvinces <- list.dirs(dtadir, full.names = F, recursive = F)
publicProvinces <- stringi::stri_trans_general(publicProvinces, "any-ascii")
```

```{r}
load(file.path(allp, "hepatitisb_all.Rdata"))

# Child in hepB dataset
child <- hepatitisb_all[hepatitisb_all$province %in% publicProvinces &
                               hepatitisb_all$year >= 2017 &
                               hepatitisb_all$year <= 2020,]

HepBN <- unique(child$pid[child$vacname2 %in% c("HepB", "HepBN")])
DPT_HepB_Hib <- unique(child$pid[child$vacname2 %in% c("DPT_HepB_Hib", "DPT_Polio_HepB_Hib")])
DPT_HepB_Hib_only <- setdiff(DPT_HepB_Hib, HepBN)
```

HepBN (public) and HepB (private) are given to newborns or within 1 month after birth, we used them to estimate number of births. The schedule for DPT_HepB_Hib (public) and DPT_Polio_HepB_Hib (private) are at 2 month. This is the number of children (not the number of shots) received each kind of these vaccines.
```{r}
child %>% group_by(vacname2) %>% summarise(unique_ids = n_distinct(pid))
```

We group them into two categories: HepBN_HepB and DPT_HepB_Hib_andOr_Polio. There are `r format(length(DPT_HepB_Hib_only), big.mark = ",")` children (unique IDs) only receive DPT_HepB_Hib_andOr_Polio and never get vaccinated with HepBN or HepB. Look like this is the sign of 1 child - multiple IDs that Thai said.
```{r}
ggvenn(
  list(HepBN_HepB = HepBN, DPT_HepB_Hib_andOr_Polio = DPT_HepB_Hib)
)
```


```{r}
load(file.path(allp, "measle_all.Rdata"))

# Get public provinces only
measle_all <- measle_all[measle_all$province %in% publicProvinces &
                           measle_all$year >= 2017 & measle_all$year <= 2020,]
measle_all <- measle_all %>% distinct(., pid, province, district, commune, sex, dob, vacname2, vacdate, .keep_all = TRUE)
measle_all <- measle_all %>%
  group_by(pid, vacname2) %>%
  arrange(vacdate) %>%
  mutate(shot = 1:n()) %>%
  ungroup()
measle_all <- data.table(measle_all)
measle_all$age <- 2021 - measle_all$year
measle_all$sex <- ifelse(measle_all$sex==2, 1, measle_all$sex)
measle_all$sex <- factor(measle_all$sex, levels=c(0,1), labels=c("F","M"))
measle_all$shot2 <- ifelse(measle_all$shot >= 2, 2, measle_all$shot)
measle_all$start2 <- ifelse(measle_all$shot2 == 2, NA, measle_all$start)
measle_all$start2 <- ifelse(measle_all$vacname2 == "Measle_Mumps_Rubella" & measle_all$shot2 == 1, 12, measle_all$start2)
measle_all$vdelay2 <- measle_all$vagem2 - measle_all$start2
mea_all_overall <- measle_all[, .N, by = .(vyear, vmonth)]
mea_all <- measle_all[, .N, by = .(vyear, vmonth, type)]

# Get 1st shot measle
measle_all <- measle_all[measle_all$shot == 1,]
measle_all$expect_vdate <- measle_all$dob %m+% months(measle_all$start)
measle_all$expect_vmonth <- month(measle_all$expect_vdate)
measle_all$expect_vyear <- year(measle_all$expect_vdate)
```

```{r}
id_measles <- unique(measle_all$pid)
id_measles_only <- setdiff(id_measles, HepBN)
```

When compare the IDs of HepBN/HepB with Measles, there are `r format(length(id_measles_only), big.mark = ",")` children received only Measles vaccine but their IDs are not in the HepBN/HepB set.
```{r}
ggvenn(
  list(HepBN_HepB = HepBN, Measles = id_measles)
)
```

The proportions of unique IDs to each set are unexpectedly high. We suspect this is because some children have several IDs as Thai's explanation. Immediately when they were born and got their HepBN/HepB shot they have ID1. At 2 month, they get their 5 in 1 vaccine shot (DPT_HepB_Hib/DPT_Polio_HepB_Hib) and someone make them new ID2. And then it is unsure when they go to get their Measle shot which ID they brought.

If we combine both the IDs in HepBN/HepB/DPT_HepB_Hib/DPT_Polio_HepB_Hib, now only 42,568 IDs are unique to the Measles.
```{r}
ggvenn(
  list(HepBN_HepB = HepBN, DPT_HepB_Hib_andOr_Polio = DPT_HepB_Hib, Measles = id_measles),
  text_size = 3,
  set_name_size = 4
)
```

So now the IDs unique to HepBN/HepB can't be used to estimate the children who never get Measles shot. For example, the child got ID1 when received HepBN/HepB, then get a new ID2 for the DPT_HepB_Hib, she then use ID2 to get the Measles shot. So ID1 is never been used and belongs to the 376,325 unique IDs of HepBN/HepB but that doesn't mean the child didn't get Measles shot.

# Delay distribution

## Measles
```{r}
measle_m <- measle_all[vacname2 == "Measle" & year >= 2017 & year <= 2020 & vdelay>=0 & expect_vyear %in% c(2019, 2020),]

ggplot(data = measle_m, aes(x = vdelay2, fill = factor(expect_vyear))) +
  geom_density(alpha = 0.5) +
  xlim(0, 6) +
  theme_ridges() +
  facet_wrap(vars(expect_vmonth), nrow = 3, scales = "free_y") +
  labs(y = NULL, x = "Delay (months)", fill = "Year") +
  ggtitle("Measles") + 
  theme(axis.text.y=element_blank())
```

## Measles Mumps Rubella
```{r}
measle_mmr <- measle_all[vacname2 == "Measle_Mumps_Rubella" & year >= 2017 & year <= 2020 & vdelay>=0 & expect_vyear %in% c(2019, 2020),]

ggplot(data = measle_mmr, aes(x = vdelay2, fill = factor(expect_vyear))) +
  geom_density(alpha = 0.5) +
  xlim(0, 8) +
  theme_ridges() +
  facet_wrap(vars(expect_vmonth), nrow = 3, scales = "free_y") +
  labs(y = NULL, x = "Delay (months)", fill = "Year") +
  ggtitle("Measles Mumps Rubella") + 
  theme(axis.text.y=element_blank())
```

## Measles Rubella
```{r}
measle_mr <- measle_all[vacname2 == "Measle_Rubella" & year >= 2017 & year <= 2020 & vdelay>=0 & expect_vyear %in% c(2019, 2020),]

ggplot(data = measle_mr, aes(x = vdelay2, fill = factor(expect_vyear))) +
  geom_density(alpha = 0.5) +
  xlim(0, 6) +
  theme_ridges() +
  facet_wrap(vars(expect_vmonth), nrow = 3, scales = "free_y") +
  labs(y = NULL, x = "Delay (months)", fill = "Year") +
  ggtitle("Measles Rubella") + 
  theme(axis.text.y=element_blank())
```

```{r}
library(lubridate)

measle_all_delay <- measle_all %>%
  select(pid, province, district, commune, sex, dob, vacname2, start2, shot2, vacdate, vyear, vmonth, year, month, vagem, vagem2, vdelay2, vsche, vsyear, vsmonth, vdelayd, type, type2) %>% filter(year>=2017 & year<=2020) %>%
  mutate(vdelay_outcome=ifelse(vdelay2>=1,1,0), # vdelay >= 1 month
         age=2021-year,
         shot2=factor(shot2),
         vacdate_f=ifelse(vacdate<"2020-04-01",0,1),
         vacdate_f=factor(vacdate_f, levels = c(0,1), labels = c("Before", "After"))) %>% 
  filter(province!="Tinh tap huan")

measle_all_delay$vdelay_outcome <- factor(measle_all_delay$vdelay_outcome, levels = c(0, 1),
                                          labels = c("Not delay", "Delay"))

library("rms")
theme_set(theme_bw())
dd <- datadist(measle_all_delay)
options(datadist="dd")
```
## Multivariable analysis
```{r}
fit6 <- lrm(vdelay_outcome~vacdate_f + province + age + type, data=measle_all_delay, maxit=1000)
anova(fit6)
pred <- Predict(fit6, fun=plogis)
```

```{r, fig.height=7}
ggplot(pred, ylab=expression(paste(hat(P),"(delay)")), vnames = "names")
```
