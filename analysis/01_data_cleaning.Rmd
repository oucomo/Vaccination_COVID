---
title: "Data Cleaning"
date: " 2021-01-26 (update: `r Sys.Date()`)"
output:
    html_document:
      theme: cerulean
      toc: yes
      toc_float: yes
editor_options:
  chunk_output_type: console
---

## Import and merge data

```{r}
#source(file.path("code", "01_import_merge.R"))
#source(file.path("code", "01_import_merge (win).R")) # for Windows version
```

## Load data

```{r}
library(data.table)
library(lubridate)
library(tidyverse)
library(dplyr)

mutate <- dplyr::mutate

data_path <- file.path("..", "tuann349_vad")
dat <- readRDS(file = file.path("..", "tuann349_vad", "alldat.rds"))
```

## Check data

### Data duplication

```{r}
## To increase the storage capacity
memory.limit(size=60000)

dupsID = dat %>%
  group_by(pid, vacdate, vacname) %>%
  distinct(.keep_all = TRUE) %>%
  group_by(pid, vacdate, vacname) %>%
  filter(n() == 1)

dat$check = dat$pid %in% dupsID$pid
nodups <- dat[check==TRUE]
dups <- dat[check==FALSE]
dups$type <- "Have a same vaccine in a same date in different provinces"
nrow(dups)
range(dups$vacdate)
table(dups$province)

dups_error <- dups[, .(pid, file, dob, vacname, vacdate, type)]
fwrite(x = dups_error, file = file.path(data_path, "error_duplicate.csv"))
```

### Dates mismatch

#### Date of vaccination before 2017-01-01

```{r}
error1 <- dat[vacdate < ymd("2017-01-01")]
error1$type <- "Date of vaccination before 2017-01-01"
nrow(error1)
range(error1$vacdate)
table(error1$province)
```

#### Date of vaccination after 2021-01-26

```{r}
error2 <- dat[vacdate >= ymd("2021-01-26")]
error2$type <- "Date of vaccination after 2021-01-26"
nrow(error2)
range(error2$vacdate)
table(error2$province)
```

#### Date of vaccination before date of birth

```{r}
error3 <- dat[(vacdate >= ymd("2017-01-01")) & (vacdate < ymd("2021-01-26")) & (vacdate < dob)]
error3$type <- "Date of vaccination before date of birth"
nrow(error3)
table(error3$province)
```

#### Export list of errors

```{r}
error <- rbindlist(l = list(error1[, .(pid, file, dob, vacdate, type)], 
                            error2[, .(pid, file, dob, vacdate, type)],
                            error3[, .(pid, file, dob, vacdate, type)]))
fwrite(x = error, file = file.path(data_path, "error_datetime.csv"))
```

