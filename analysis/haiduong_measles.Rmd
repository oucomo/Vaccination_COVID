---
title: "Hai Duong: Measles"
author: "Duc Du, Thinh Ong"
date: ' 2020-01-29 (update: `r Sys.Date()`)'
output:
  workflowr::wflow_html:
    toc: true
    theme: cosmo
  pdf_document:
    toc: yes
  html_document:
    theme: cerulean
    toc: yes
    toc_float: yes
  word_document:
    toc: yes
editor_options:
  chunk_output_type: inline
---

```{r include = F}
knitr::opts_chunk$set(echo = F, warning = F, message = F, out.width = "100%")

library(data.table)
library(dplyr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(gtsummary)
library(ggsci)
library(plotly)
library(seewave)
library(dgof)

pv_name <- "haiduong"
vacc_include <- c("Measles", "MR", "MMR")
vacc_hepb <- "HepB"

datap <- file.path("~", "data", "vaccine_registry", "merged")
metap <- file.path("~", "data", "vaccine_registry", "metadata")
dtoutp <- file.path("~", "data", "vaccine_registry", "output")

covidvc <- readRDS(file.path(metap, "Combined_VAC_COVID19_2022-02-17.rds"))
df_all <- readRDS(file.path(datap, paste0(pv_name, ".rds")))
df_all <- data.table(df_all)
measles_all <- df_all[which(df_all$vacname %in% vacc_include),]

hepb <- df_all[which(df_all$vacname %in% vacc_hepb)]
hepb <- hepb[which(hepb$shot == 1),]

time_step <- "month"
measles_all$vacym <- floor_date(measles_all$vacdate, time_step)
measles_all$vacname <- factor(measles_all$vacname, levels = vacc_include)

hepb$dob_ym <- floor_date(hepb$dob, time_step)
measles_all$dob_ym <- floor_date(measles_all$dob, time_step)
measles_all$vac_ym <- floor_date(measles_all$vacdate, time_step)

# Schedule vaccination date of children
measles_all$skd_date <- measles_all$dob + months(measles_all$start)
measles_all$skd_ym <- floor_date(measles_all$skd_date, time_step)
measles_all$skd_year <- year(measles_all$skd_date)
measles_all$skd_month <- month(measles_all$skd_date)

# How many shots each children received?
measles_all <- measles_all %>%
  group_by(pid) %>%
  arrange(vacdate) %>%
  mutate(shot_any = 1:n()) %>%
  ungroup()

# Setup 2 functions for computing vaccine coverage
vaccov <- function(kids, measles_all, vcnames, schedule, months_follow, yrs, step_back = 1) {
  
  # Start from step_back month(s) before the schedule date
  start_at <- schedule - step_back
  
  # Store outputs in these vectors
  # length_vars = 12 cohorts in a year * n years * n months follow each cohort
  length_vars <- 12 * length(yrs) * length(months_follow)
  cohorts <- Date(length_vars)
  month_covs <- Date(length_vars)
  n_months <- numeric(length_vars)
  n_hepbs <- numeric(length_vars)
  n_measless <- numeric(length_vars)
  covs <- numeric(length_vars)
  
  # Start with index 1 and increase after each iteration
  idx <- 1
  
  # Loop through the years of the cohorts
  for (yr in yrs) {
    
    # Make a vector contains 12 months in the year of interest
    start_yr <- ym(paste0(yr, "-01"))
    end_yr <- ym(paste0(yr, "-12"))
    
    # range_yr should be a Date vector c("2017-01-01", "2017-02-01"...) until "2017-12-01"
    range_yr <- seq(start_yr, end_yr, "months")
    
    for (i in 1:length(range_yr)) {
      
      # Get the month of birth of this cohort
      cohort <- range_yr[i]
      
      # Number of kids taken from Hep B
      kids <- hepb %>% 
        filter(
          dob_ym == cohort
        ) %>% 
        nrow()
      
      for (j in 1:months_follow) {
        
        # Schedule for the 1st shot is defined by variable start_at
        start_shots <- cohort + months(start_at)
        
        # The range to get cumulative vaccine coverage
        end_shots <- start_shots + months(j - 1)
      
        shots <- measles_all %>% 
          filter(
            dob_ym == cohort,
            # Month of vaccination between start and end
            vac_ym >= start_shots,
            vac_ym <= end_shots,
            vacname %in% vcnames
          ) %>%
          distinct(., pid, .keep_all = F) %>%
          nrow()
        
        cohorts[idx] <- cohort 
        month_covs[idx] <- end_shots
        n_months[idx] <- j + start_at - 1
        n_hepbs[idx] <- kids
        n_measless[idx] <- shots
        covs[idx] <- shots / kids
        
        idx <- idx + 1
      }
    }
  }
  
  df_cov <- data.frame(
    cohort = cohorts, 
    schedule_date = cohorts + months(schedule),
    month_cov = month_covs,
    n_month = n_months, 
    n_month_delay = n_months - schedule,
    n_hepb = n_hepbs,
    n_measles = n_measless,
    cov = covs
  )
  
  df_cov
}

vaccov_2shots <- function(kids, measles_all, vcnames, schedule, months_follow, yrs, step_back = 1) {
  
  # Start from 1 month before the schedule date
  start_at <- schedule - step_back
  
  # Variables to store outputs
  # length_vars = 12 cohorts in a year * n years * n months follow each cohort
  length_vars <- 12 * length(yrs) * length(months_follow)
  cohorts <- Date(length_vars)
  month_covs <- Date(length_vars)
  n_months <- numeric(length_vars)
  n_hepbs <- numeric(length_vars)
  n_measless <- numeric(length_vars)
  covs <- numeric(length_vars)
  
  # Start with index 1 and increase after each iteration
  idx <- 1
  
  # Loop through the years of the cohorts
  for (yr in yrs) {
    
    # Make a vector contains 12 months in the year of interest
    start_yr <- ym(paste0(yr, "-01"))
    end_yr <- ym(paste0(yr, "-12"))
    
    # range_yr should be a Date vector c("2017-01-01", "2017-02-01"...) until "2017-12-01"
    range_yr <- seq(start_yr, end_yr, "months")
    
    for (i in 1:length(range_yr)) {
      
      # Get the month of birth of this cohort
      cohort <- range_yr[i]
      
      # Number of kids taken from Hep B
      kids <- hepb %>% 
        filter(
          dob_ym == cohort
        ) %>% 
        nrow()
      
      for (j in 1:months_follow) {
        
        # Schedule for the 1st shot is defined by variable start_at
        start_shots <- cohort + months(start_at)
        
        # The range to get cumulative vaccine coverage
        end_shots <- start_shots + months(j - 1)
      
        shots <- measles_all %>% 
          filter(
            dob_ym == cohort,
            # Month of vaccination between start and end
            vac_ym >= start_shots,
            vac_ym <= end_shots,
            vacname %in% vcnames,
            shot_any == 2
          ) %>%
          distinct(., pid, .keep_all = F) %>%
          nrow()
        
        cohorts[idx] <- cohort 
        month_covs[idx] <- end_shots
        n_months[idx] <- j + start_at - 1
        n_hepbs[idx] <- kids
        n_measless[idx] <- shots
        covs[idx] <- shots / kids
        
        idx <- idx + 1
      }
    }
  }
  
  df_cov <- data.frame(
    cohort = cohorts, 
    month_cov = month_covs,
    schedule_date = cohorts + months(schedule),
    n_month = n_months, 
    n_month_delay = n_months - schedule,
    n_hepb = n_hepbs,
    n_measles = n_measless,
    cov = covs
  )
  
  df_cov
}
```

# Vaccine coverage

# At least 1 shot

## Measles

```{r}
df_cov <- vaccov(kids = kids, measles_all = measles_all,
                 vcnames = c("Measles"), 
                 schedule = 9, 
                 months_follow = 13,
                 yrs = c(2017, 2018, 2019, 2020, 2021))
df_cov <- df_cov[df_cov$month_cov <= "2022-07-01",]
```

### 2018

```{r}
# Set year
yr <- 2018

df_plot <- df_cov[which(year(df_cov$schedule_date) == yr),]

# Format df_plot for plot display
df_plot$schedule_date <- format(df_plot$schedule_date, format = "%b-%Y")
df_plot$schedule_date <- reorder(df_plot$schedule_date, my(df_plot$schedule_date))
df_plot$month_cov <- format(df_plot$month_cov, format = "%b-%Y")

plot_ly(
  df_plot, x = ~n_month_delay, y = ~cov, color = ~schedule_date,
  type = "scatter", mode = "lines",
  hovertext = paste0("Schedule date: ", df_plot$schedule_date, "<br>",
                     "Cutoff month: ", df_plot$month_cov, "<br>",
                     "No. months delayed from schedule: ", df_plot$n_month_delay, "<br>",
                     "Coverage: ", df_plot$cov),
  hoverinfo = "text") %>%
  layout(
    xaxis = list(
      range = c(min(df_plot$n_month_delay) - 1, max(df_plot$n_month_delay) + 1),
      title = "Number of months delayed from schedule (months)"
    ),
    yaxis = list(
      range = c(0, max(df_plot$cov) + 0.1),
      title = "Vaccine coverage"
    ),
    legend = list(
      title = list(text = "Schedule")
    )
  )
```

### 2019

```{r}
# Set year
yr <- 2019

df_plot <- df_cov[which(year(df_cov$schedule_date) == yr),]

# Format df_plot for plot display
df_plot$schedule_date <- format(df_plot$schedule_date, format = "%b-%Y")
df_plot$schedule_date <- reorder(df_plot$schedule_date, my(df_plot$schedule_date))
df_plot$month_cov <- format(df_plot$month_cov, format = "%b-%Y")

plot_ly(
  df_plot, x = ~n_month_delay, y = ~cov, color = ~schedule_date,
  type = "scatter", mode = "lines",
  hovertext = paste0("Schedule date: ", df_plot$schedule_date, "<br>",
                     "Cutoff month: ", df_plot$month_cov, "<br>",
                     "No. months delayed from schedule: ", df_plot$n_month_delay, "<br>",
                     "Coverage: ", df_plot$cov),
  hoverinfo = "text") %>%
  layout(
    xaxis = list(
      range = c(min(df_plot$n_month_delay) - 1, max(df_plot$n_month_delay) + 1),
      title = "Number of months delayed from schedule (months)"
    ),
    yaxis = list(
      range = c(0, max(df_plot$cov) + 0.1),
      title = "Vaccine coverage"
    ),
    legend = list(
      title = list(text = "Schedule")
    )
  )
```

### 2020

```{r}
# Set year
yr <- 2020

df_plot <- df_cov[which(year(df_cov$schedule_date) == yr),]

# Format df_plot for plot display
df_plot$schedule_date <- format(df_plot$schedule_date, format = "%b-%Y")
df_plot$schedule_date <- reorder(df_plot$schedule_date, my(df_plot$schedule_date))
df_plot$month_cov <- format(df_plot$month_cov, format = "%b-%Y")

plot_ly(
  df_plot, x = ~n_month_delay, y = ~cov, color = ~schedule_date,
  type = "scatter", mode = "lines",
  hovertext = paste0("Schedule date: ", df_plot$schedule_date, "<br>",
                     "Cutoff month: ", df_plot$month_cov, "<br>",
                     "No. months delayed from schedule: ", df_plot$n_month_delay, "<br>",
                     "Coverage: ", df_plot$cov),
  hoverinfo = "text") %>%
  layout(
    xaxis = list(
      range = c(min(df_plot$n_month_delay) - 1, max(df_plot$n_month_delay) + 1),
      title = "Number of months delayed from schedule (months)"
    ),
    yaxis = list(
      range = c(0, max(df_plot$cov) + 0.1),
      title = "Vaccine coverage"
    ),
    legend = list(
      title = list(text = "Schedule")
    )
  )
```

### 2021

```{r}
# Set year
yr <- 2021

df_plot <- df_cov[which(year(df_cov$schedule_date) == yr),]

# Format df_plot for plot display
df_plot$schedule_date <- format(df_plot$schedule_date, format = "%b-%Y")
df_plot$schedule_date <- reorder(df_plot$schedule_date, my(df_plot$schedule_date))
df_plot$month_cov <- format(df_plot$month_cov, format = "%b-%Y")

plot_ly(
  df_plot, x = ~n_month_delay, y = ~cov, color = ~schedule_date,
  type = "scatter", mode = "lines",
  hovertext = paste0("Schedule date: ", df_plot$schedule_date, "<br>",
                     "Cutoff month: ", df_plot$month_cov, "<br>",
                     "No. months delayed from schedule: ", df_plot$n_month_delay, "<br>",
                     "Coverage: ", df_plot$cov),
  hoverinfo = "text") %>%
  layout(
    xaxis = list(
      range = c(min(df_plot$n_month_delay) - 1, max(df_plot$n_month_delay) + 1),
      title = "Number of months delayed from schedule (months)"
    ),
    yaxis = list(
      range = c(0, max(df_plot$cov) + 0.1),
      title = "Vaccine coverage"
    ),
    legend = list(
      title = list(text = "Schedule")
    )
  )
```

### Compare cohorts between years

```{r}
m_delays <- c(0, 1, 2, 4, 6, 8)

df_plot <- df_cov %>% filter(n_month_delay %in% m_delays)

# Format to display month as Jan, Feb
df_plot$schedule_month <- format(df_plot$schedule_date, format = "%b")
# Set correct order (J > F > M > A...)
df_plot$schedule_month <- factor(df_plot$schedule_month, levels = month.abb)

df_plot$schedule_year <- format(df_plot$schedule_date, format = "%Y")
df_plot$schedule_year <- factor(df_plot$schedule_year)

ggplot(df_plot, aes(x = schedule_month, y = cov, group = schedule_year)) +
  geom_point(aes(shape = schedule_year, color = schedule_year)) +
  ylim(0, 1.2) +
  scale_x_discrete(label = function(x) abbreviate(x, minlength = 1, strict = T)) +
  facet_wrap(~ n_month_delay) +
  theme_light()
```

```{r}
m_delays <- c(0, 1, 2, 4, 6, 8)

df_plot <- df_cov %>% filter(n_month_delay %in% m_delays, year(schedule_date) %in% c(2019, 2020, 2021))

# Format to display month as Jan, Feb
df_plot$schedule_month <- format(df_plot$schedule_date, format = "%b")
# Set correct order (J > F > M > A...)
df_plot$schedule_month <- factor(df_plot$schedule_month, levels = month.abb)

df_plot$schedule_year <- format(df_plot$schedule_date, format = "%Y")
df_plot$schedule_year <- factor(df_plot$schedule_year)

ggplot(df_plot, aes(x = schedule_month, y = cov, group = schedule_year)) +
  geom_point(aes(shape = schedule_year, color = schedule_year)) +
  ylim(0, 1) +
  scale_x_discrete(label = function(x) abbreviate(x, minlength = 1, strict = T)) +
  facet_wrap(~ n_month_delay) +
  labs(x = "Schedule month", y = "Coverage", color = "Schedule year", shape = "Schedule year") +
  theme_light()
ggsave("~/figs/haiduong_cov.pdf", width = 7, height = 4)
```

## Measles or MR

```{r}
df_cov <- vaccov(kids = kids, measles_all = measles_all,
                 vcnames = c("Measles", "MR"), 
                 schedule = 9,
                 months_follow = 13,
                 yrs = c(2017, 2018, 2019, 2020, 2021))
```

### 2018

```{r}
# Set year
yr <- 2018

df_plot <- df_cov[which(year(df_cov$schedule_date) == yr),]

# Format df_plot for plot display
df_plot$schedule_date <- format(df_plot$schedule_date, format = "%b-%Y")
df_plot$schedule_date <- reorder(df_plot$schedule_date, my(df_plot$schedule_date))
df_plot$month_cov <- format(df_plot$month_cov, format = "%b-%Y")

plot_ly(
  df_plot, x = ~n_month_delay, y = ~cov, color = ~schedule_date,
  type = "scatter", mode = "lines",
  hovertext = paste0("Schedule date: ", df_plot$schedule_date, "<br>",
                     "Cutoff month: ", df_plot$month_cov, "<br>",
                     "No. months delayed from schedule: ", df_plot$n_month_delay, "<br>",
                     "Coverage: ", df_plot$cov),
  hoverinfo = "text") %>%
  layout(
    xaxis = list(
      range = c(min(df_plot$n_month_delay) - 1, max(df_plot$n_month_delay) + 1),
      title = "Number of months delayed from schedule (months)"
    ),
    yaxis = list(
      range = c(0, max(df_plot$cov) + 0.1),
      title = "Vaccine coverage"
    ),
    legend = list(
      title = list(text = "Schedule")
    )
  )
```

### 2019

```{r}
# Set year
yr <- 2019

df_plot <- df_cov[which(year(df_cov$schedule_date) == yr),]

# Format df_plot for plot display
df_plot$schedule_date <- format(df_plot$schedule_date, format = "%b-%Y")
df_plot$schedule_date <- reorder(df_plot$schedule_date, my(df_plot$schedule_date))
df_plot$month_cov <- format(df_plot$month_cov, format = "%b-%Y")

plot_ly(
  df_plot, x = ~n_month_delay, y = ~cov, color = ~schedule_date,
  type = "scatter", mode = "lines",
  hovertext = paste0("Schedule date: ", df_plot$schedule_date, "<br>",
                     "Cutoff month: ", df_plot$month_cov, "<br>",
                     "No. months delayed from schedule: ", df_plot$n_month_delay, "<br>",
                     "Coverage: ", df_plot$cov),
  hoverinfo = "text") %>%
  layout(
    xaxis = list(
      range = c(min(df_plot$n_month_delay) - 1, max(df_plot$n_month_delay) + 1),
      title = "Number of months delayed from schedule (months)"
    ),
    yaxis = list(
      range = c(0, max(df_plot$cov) + 0.1),
      title = "Vaccine coverage"
    ),
    legend = list(
      title = list(text = "Schedule")
    )
  )
```

### 2020

```{r}
# Set year
yr <- 2020

df_plot <- df_cov[which(year(df_cov$schedule_date) == yr),]

# Format df_plot for plot display
df_plot$schedule_date <- format(df_plot$schedule_date, format = "%b-%Y")
df_plot$schedule_date <- reorder(df_plot$schedule_date, my(df_plot$schedule_date))
df_plot$month_cov <- format(df_plot$month_cov, format = "%b-%Y")

plot_ly(
  df_plot, x = ~n_month_delay, y = ~cov, color = ~schedule_date,
  type = "scatter", mode = "lines",
  hovertext = paste0("Schedule date: ", df_plot$schedule_date, "<br>",
                     "Cutoff month: ", df_plot$month_cov, "<br>",
                     "No. months delayed from schedule: ", df_plot$n_month_delay, "<br>",
                     "Coverage: ", df_plot$cov),
  hoverinfo = "text") %>%
  layout(
    xaxis = list(
      range = c(min(df_plot$n_month_delay) - 1, max(df_plot$n_month_delay) + 1),
      title = "Number of months delayed from schedule (months)"
    ),
    yaxis = list(
      range = c(0, max(df_plot$cov) + 0.1),
      title = "Vaccine coverage"
    ),
    legend = list(
      title = list(text = "Schedule")
    )
  )
```

### 2021

```{r}
# Set year
yr <- 2021

df_plot <- df_cov[which(year(df_cov$schedule_date) == yr),]

# Format df_plot for plot display
df_plot$schedule_date <- format(df_plot$schedule_date, format = "%b-%Y")
df_plot$schedule_date <- reorder(df_plot$schedule_date, my(df_plot$schedule_date))
df_plot$month_cov <- format(df_plot$month_cov, format = "%b-%Y")

plot_ly(
  df_plot, x = ~n_month_delay, y = ~cov, color = ~schedule_date,
  type = "scatter", mode = "lines",
  hovertext = paste0("Schedule date: ", df_plot$schedule_date, "<br>",
                     "Cutoff month: ", df_plot$month_cov, "<br>",
                     "No. months delayed from schedule: ", df_plot$n_month_delay, "<br>",
                     "Coverage: ", df_plot$cov),
  hoverinfo = "text") %>%
  layout(
    xaxis = list(
      range = c(min(df_plot$n_month_delay) - 1, max(df_plot$n_month_delay) + 1),
      title = "Number of months delayed from schedule (months)"
    ),
    yaxis = list(
      range = c(0, max(df_plot$cov) + 0.1),
      title = "Vaccine coverage"
    ),
    legend = list(
      title = list(text = "Schedule")
    )
  )
```


### Compare cohorts between years

```{r}
m_delays <- c(0, 1, 2, 4, 6, 8)

df_plot <- df_cov %>% filter(n_month_delay %in% m_delays)

# Format to display month as Jan, Feb
df_plot$schedule_month <- format(df_plot$schedule_date, format = "%b")
# Set correct order (J > F > M > A...)
df_plot$schedule_month <- factor(df_plot$schedule_month, levels = month.abb)

df_plot$schedule_year <- format(df_plot$schedule_date, format = "%Y")
df_plot$schedule_year <- factor(df_plot$schedule_year)

ggplot(df_plot, aes(x = schedule_month, y = cov, group = schedule_year)) +
  geom_point(aes(shape = schedule_year, color = schedule_year)) +
  ylim(0, 1.2) +
  scale_x_discrete(label = function(x) abbreviate(x, minlength = 1, strict = T)) +
  facet_wrap(~ n_month_delay) +
  theme_light()
```

```{r}
m_delays <- c(0, 1, 2, 4, 6, 8)

df_plot <- df_cov %>% filter(n_month_delay %in% m_delays)

# Format to display month as Jan, Feb
df_plot$birth_month <- format(df_plot$cohort, format = "%b")
# Set correct order (J > F > M > A...)
df_plot$birth_month <- factor(df_plot$birth_month, levels = month.abb)

df_plot$birth_year <- format(df_plot$cohort, format = "%Y")
df_plot$birth_year <- factor(df_plot$birth_year)

ggplot(df_plot, aes(x = birth_month, y = cov, group = birth_year)) +
  geom_point(aes(shape = birth_year, color = birth_year)) +
  ylim(0, 1.2) +
  scale_x_discrete(label = function(x) abbreviate(x, minlength = 1, strict = T)) +
  facet_wrap(~ n_month_delay) +
  theme_light()
```

## Measles, MR or MMR

```{r}
df_cov <- vaccov(kids = kids, measles_all = measles_all,
                 vcnames = c("Measles", "MR", "MMR"), 
                 schedule = 9,
                 months_follow = 13,
                 yrs = c(2017, 2018, 2019, 2020, 2021))
```

### 2018

```{r}
# Set year
yr <- 2018

df_plot <- df_cov[which(year(df_cov$schedule_date) == yr),]

# Format df_plot for plot display
df_plot$schedule_date <- format(df_plot$schedule_date, format = "%b-%Y")
df_plot$schedule_date <- reorder(df_plot$schedule_date, my(df_plot$schedule_date))
df_plot$month_cov <- format(df_plot$month_cov, format = "%b-%Y")

plot_ly(
  df_plot, x = ~n_month_delay, y = ~cov, color = ~schedule_date,
  type = "scatter", mode = "lines",
  hovertext = paste0("Schedule date: ", df_plot$schedule_date, "<br>",
                     "Cutoff month: ", df_plot$month_cov, "<br>",
                     "No. months delayed from schedule: ", df_plot$n_month_delay, "<br>",
                     "Coverage: ", df_plot$cov),
  hoverinfo = "text") %>%
  layout(
    xaxis = list(
      range = c(min(df_plot$n_month_delay) - 1, max(df_plot$n_month_delay) + 1),
      title = "Number of months delayed from schedule (months)"
    ),
    yaxis = list(
      range = c(0, max(df_plot$cov) + 0.1),
      title = "Vaccine coverage"
    ),
    legend = list(
      title = list(text = "Schedule")
    )
  )
```

### 2019

```{r}
# Set year
yr <- 2019

df_plot <- df_cov[which(year(df_cov$schedule_date) == yr),]

# Format df_plot for plot display
df_plot$schedule_date <- format(df_plot$schedule_date, format = "%b-%Y")
df_plot$schedule_date <- reorder(df_plot$schedule_date, my(df_plot$schedule_date))
df_plot$month_cov <- format(df_plot$month_cov, format = "%b-%Y")

plot_ly(
  df_plot, x = ~n_month_delay, y = ~cov, color = ~schedule_date,
  type = "scatter", mode = "lines",
  hovertext = paste0("Schedule date: ", df_plot$schedule_date, "<br>",
                     "Cutoff month: ", df_plot$month_cov, "<br>",
                     "No. months delayed from schedule: ", df_plot$n_month_delay, "<br>",
                     "Coverage: ", df_plot$cov),
  hoverinfo = "text") %>%
  layout(
    xaxis = list(
      range = c(min(df_plot$n_month_delay) - 1, max(df_plot$n_month_delay) + 1),
      title = "Number of months delayed from schedule (months)"
    ),
    yaxis = list(
      range = c(0, max(df_plot$cov) + 0.1),
      title = "Vaccine coverage"
    ),
    legend = list(
      title = list(text = "Schedule")
    )
  )
```

### 2020

```{r}
# Set year
yr <- 2020

df_plot <- df_cov[which(year(df_cov$schedule_date) == yr),]

# Format df_plot for plot display
df_plot$schedule_date <- format(df_plot$schedule_date, format = "%b-%Y")
df_plot$schedule_date <- reorder(df_plot$schedule_date, my(df_plot$schedule_date))
df_plot$month_cov <- format(df_plot$month_cov, format = "%b-%Y")

plot_ly(
  df_plot, x = ~n_month_delay, y = ~cov, color = ~schedule_date,
  type = "scatter", mode = "lines",
  hovertext = paste0("Schedule date: ", df_plot$schedule_date, "<br>",
                     "Cutoff month: ", df_plot$month_cov, "<br>",
                     "No. months delayed from schedule: ", df_plot$n_month_delay, "<br>",
                     "Coverage: ", df_plot$cov),
  hoverinfo = "text") %>%
  layout(
    xaxis = list(
      range = c(min(df_plot$n_month_delay) - 1, max(df_plot$n_month_delay) + 1),
      title = "Number of months delayed from schedule (months)"
    ),
    yaxis = list(
      range = c(0, max(df_plot$cov) + 0.1),
      title = "Vaccine coverage"
    ),
    legend = list(
      title = list(text = "Schedule")
    )
  )
```

### 2021

```{r}
# Set year
yr <- 2021

df_plot <- df_cov[which(year(df_cov$schedule_date) == yr),]

# Format df_plot for plot display
df_plot$schedule_date <- format(df_plot$schedule_date, format = "%b-%Y")
df_plot$schedule_date <- reorder(df_plot$schedule_date, my(df_plot$schedule_date))
df_plot$month_cov <- format(df_plot$month_cov, format = "%b-%Y")

plot_ly(
  df_plot, x = ~n_month_delay, y = ~cov, color = ~schedule_date,
  type = "scatter", mode = "lines",
  hovertext = paste0("Schedule date: ", df_plot$schedule_date, "<br>",
                     "Cutoff month: ", df_plot$month_cov, "<br>",
                     "No. months delayed from schedule: ", df_plot$n_month_delay, "<br>",
                     "Coverage: ", df_plot$cov),
  hoverinfo = "text") %>%
  layout(
    xaxis = list(
      range = c(min(df_plot$n_month_delay) - 1, max(df_plot$n_month_delay) + 1),
      title = "Number of months delayed from schedule (months)"
    ),
    yaxis = list(
      range = c(0, max(df_plot$cov) + 0.1),
      title = "Vaccine coverage"
    ),
    legend = list(
      title = list(text = "Schedule")
    )
  )
```

### Compare cohorts between years

```{r}
m_delays <- c(0, 1, 2, 4, 6, 8)

df_plot <- df_cov %>% filter(n_month_delay %in% m_delays)

# Format to display month as Jan, Feb
df_plot$schedule_month <- format(df_plot$schedule_date, format = "%b")
# Set correct order (J > F > M > A...)
df_plot$schedule_month <- factor(df_plot$schedule_month, levels = month.abb)

df_plot$schedule_year <- format(df_plot$schedule_date, format = "%Y")
df_plot$schedule_year <- factor(df_plot$schedule_year)

ggplot(df_plot, aes(x = schedule_month, y = cov, group = schedule_year)) +
  geom_point(aes(shape = schedule_year, color = schedule_year)) +
  ylim(0, 1.2) +
  scale_x_discrete(label = function(x) abbreviate(x, minlength = 1, strict = T)) +
  facet_wrap(~ n_month_delay) +
  theme_light()
```

```{r}
m_delays <- c(0, 1, 2, 4, 6, 8)

df_plot <- df_cov %>% filter(n_month_delay %in% m_delays)

# Format to display month as Jan, Feb
df_plot$birth_month <- format(df_plot$cohort, format = "%b")
# Set correct order (J > F > M > A...)
df_plot$birth_month <- factor(df_plot$birth_month, levels = month.abb)

df_plot$birth_year <- format(df_plot$cohort, format = "%Y")
df_plot$birth_year <- factor(df_plot$birth_year)

ggplot(df_plot, aes(x = birth_month, y = cov, group = birth_year)) +
  geom_point(aes(shape = birth_year, color = birth_year)) +
  ylim(0, 1.2) +
  scale_x_discrete(label = function(x) abbreviate(x, minlength = 1, strict = T)) +
  facet_wrap(~ n_month_delay) +
  theme_light()
```


# 2 shots

## Public vaccines only (Measles, MR)

```{r}
df_cov <- vaccov_2shots(kids = kids, measles_all = measles_all,
                        vcnames = c("Measles", "MR"), 
                        schedule = 18, 
                        months_follow = 16,
                        yrs = c(2017, 2018, 2019, 2020))
```

### 2018

```{r}
# Set year
yr <- 2018

df_plot <- df_cov[which(year(df_cov$schedule_date) == yr),]

# Format df_plot for plot display
df_plot$schedule_date <- format(df_plot$schedule_date, format = "%b-%Y")
df_plot$schedule_date <- reorder(df_plot$schedule_date, my(df_plot$schedule_date))
df_plot$month_cov <- format(df_plot$month_cov, format = "%b-%Y")

plot_ly(
  df_plot, x = ~n_month_delay, y = ~cov, color = ~schedule_date,
  type = "scatter", mode = "lines",
  hovertext = paste0("Schedule date: ", df_plot$schedule_date, "<br>",
                     "Cutoff month: ", df_plot$month_cov, "<br>",
                     "No. months delayed from schedule: ", df_plot$n_month_delay, "<br>",
                     "Coverage: ", df_plot$cov),
  hoverinfo = "text") %>%
  layout(
    xaxis = list(
      range = c(min(df_plot$n_month_delay) - 1, max(df_plot$n_month_delay) + 1),
      title = "Number of months delayed from schedule (months)"
    ),
    yaxis = list(
      range = c(0, max(df_plot$cov) + 0.1),
      title = "Vaccine coverage"
    ),
    legend = list(
      title = list(text = "Schedule")
    )
  )
```

### 2019

```{r}
# Set year
yr <- 2019

df_plot <- df_cov[which(year(df_cov$schedule_date) == yr),]

# Format df_plot for plot display
df_plot$schedule_date <- format(df_plot$schedule_date, format = "%b-%Y")
df_plot$schedule_date <- reorder(df_plot$schedule_date, my(df_plot$schedule_date))
df_plot$month_cov <- format(df_plot$month_cov, format = "%b-%Y")

plot_ly(
  df_plot, x = ~n_month_delay, y = ~cov, color = ~schedule_date,
  type = "scatter", mode = "lines",
  hovertext = paste0("Schedule date: ", df_plot$schedule_date, "<br>",
                     "Cutoff month: ", df_plot$month_cov, "<br>",
                     "No. months delayed from schedule: ", df_plot$n_month_delay, "<br>",
                     "Coverage: ", df_plot$cov),
  hoverinfo = "text") %>%
  layout(
    xaxis = list(
      range = c(min(df_plot$n_month_delay) - 1, max(df_plot$n_month_delay) + 1),
      title = "Number of months delayed from schedule (months)"
    ),
    yaxis = list(
      range = c(0, max(df_plot$cov) + 0.1),
      title = "Vaccine coverage"
    ),
    legend = list(
      title = list(text = "Schedule")
    )
  )
```

### 2020

```{r}
# Set year
yr <- 2020

df_plot <- df_cov[which(year(df_cov$schedule_date) == yr),]

# Format df_plot for plot display
df_plot$schedule_date <- format(df_plot$schedule_date, format = "%b-%Y")
df_plot$schedule_date <- reorder(df_plot$schedule_date, my(df_plot$schedule_date))
df_plot$month_cov <- format(df_plot$month_cov, format = "%b-%Y")

plot_ly(
  df_plot, x = ~n_month_delay, y = ~cov, color = ~schedule_date,
  type = "scatter", mode = "lines",
  hovertext = paste0("Schedule date: ", df_plot$schedule_date, "<br>",
                     "Cutoff month: ", df_plot$month_cov, "<br>",
                     "No. months delayed from schedule: ", df_plot$n_month_delay, "<br>",
                     "Coverage: ", df_plot$cov),
  hoverinfo = "text") %>%
  layout(
    xaxis = list(
      range = c(min(df_plot$n_month_delay) - 1, max(df_plot$n_month_delay) + 1),
      title = "Number of months delayed from schedule (months)"
    ),
    yaxis = list(
      range = c(0, max(df_plot$cov) + 0.1),
      title = "Vaccine coverage"
    ),
    legend = list(
      title = list(text = "Schedule")
    )
  )
```

### 2021

```{r}
# Set year
yr <- 2020

df_plot <- df_cov[which(year(df_cov$schedule_date) == yr),]

# Format df_plot for plot display
df_plot$schedule_date <- format(df_plot$schedule_date, format = "%b-%Y")
df_plot$schedule_date <- reorder(df_plot$schedule_date, my(df_plot$schedule_date))
df_plot$month_cov <- format(df_plot$month_cov, format = "%b-%Y")

plot_ly(
  df_plot, x = ~n_month_delay, y = ~cov, color = ~schedule_date,
  type = "scatter", mode = "lines",
  hovertext = paste0("Schedule date: ", df_plot$schedule_date, "<br>",
                     "Cutoff month: ", df_plot$month_cov, "<br>",
                     "No. months delayed from schedule: ", df_plot$n_month_delay, "<br>",
                     "Coverage: ", df_plot$cov),
  hoverinfo = "text") %>%
  layout(
    xaxis = list(
      range = c(min(df_plot$n_month_delay) - 1, max(df_plot$n_month_delay) + 1),
      title = "Number of months delayed from schedule (months)"
    ),
    yaxis = list(
      range = c(0, max(df_plot$cov) + 0.1),
      title = "Vaccine coverage"
    ),
    legend = list(
      title = list(text = "Schedule")
    )
  )
```

### Compare cohorts between years

```{r}
m_delays <- c(0, 1, 2, 4, 6, 8)

df_plot <- df_cov %>% filter(n_month_delay %in% m_delays)

# Format to display month as Jan, Feb
df_plot$schedule_month <- format(df_plot$schedule_date, format = "%b")
# Set correct order (J > F > M > A...)
df_plot$schedule_month <- factor(df_plot$schedule_month, levels = month.abb)

df_plot$schedule_year <- format(df_plot$schedule_date, format = "%Y")
df_plot$schedule_year <- factor(df_plot$schedule_year)

ggplot(df_plot, aes(x = schedule_month, y = cov, group = schedule_year)) +
  geom_point(aes(shape = schedule_year, color = schedule_year)) +
  ylim(0, 1.2) +
  scale_x_discrete(label = function(x) abbreviate(x, minlength = 1, strict = T)) +
  facet_wrap(~ n_month_delay) +
  theme_light()
```

```{r}
m_delays <- c(0, 1, 2, 4, 6, 8)

df_plot <- df_cov %>% filter(n_month_delay %in% m_delays)

# Format to display month as Jan, Feb
df_plot$birth_month <- format(df_plot$cohort, format = "%b")
# Set correct order (J > F > M > A...)
df_plot$birth_month <- factor(df_plot$birth_month, levels = month.abb)

df_plot$birth_year <- format(df_plot$cohort, format = "%Y")
df_plot$birth_year <- factor(df_plot$birth_year)

ggplot(df_plot, aes(x = birth_month, y = cov, group = birth_year)) +
  geom_point(aes(shape = birth_year, color = birth_year)) +
  ylim(0, 1.2) +
  scale_x_discrete(label = function(x) abbreviate(x, minlength = 1, strict = T)) +
  facet_wrap(~ n_month_delay) +
  theme_light()
```

## Any vaccine (Measles, MR, MMR)

```{r}
df_cov <- vaccov_2shots(kids = kids, measles_all = measles_all, 
                        vcnames = c("Measles", "MR", "MMR"), 
                        schedule = 18, 
                        months_follow = 16,
                        yrs = c(2017, 2018, 2019, 2020))
```

### 2018

```{r}
# Set year
yr <- 2018

df_plot <- df_cov[which(year(df_cov$schedule_date) == yr),]

# Format df_plot for plot display
df_plot$schedule_date <- format(df_plot$schedule_date, format = "%b-%Y")
df_plot$schedule_date <- reorder(df_plot$schedule_date, my(df_plot$schedule_date))
df_plot$month_cov <- format(df_plot$month_cov, format = "%b-%Y")

plot_ly(
  df_plot, x = ~n_month_delay, y = ~cov, color = ~schedule_date,
  type = "scatter", mode = "lines",
  hovertext = paste0("Schedule date: ", df_plot$schedule_date, "<br>",
                     "Cutoff month: ", df_plot$month_cov, "<br>",
                     "No. months delayed from schedule: ", df_plot$n_month_delay, "<br>",
                     "Coverage: ", df_plot$cov),
  hoverinfo = "text") %>%
  layout(
    xaxis = list(
      range = c(min(df_plot$n_month_delay) - 1, max(df_plot$n_month_delay) + 1),
      title = "Number of months delayed from schedule (months)"
    ),
    yaxis = list(
      range = c(0, max(df_plot$cov) + 0.1),
      title = "Vaccine coverage"
    ),
    legend = list(
      title = list(text = "Schedule")
    )
  )
```

### 2019

```{r}
# Set year
yr <- 2019

df_plot <- df_cov[which(year(df_cov$schedule_date) == yr),]

# Format df_plot for plot display
df_plot$schedule_date <- format(df_plot$schedule_date, format = "%b-%Y")
df_plot$schedule_date <- reorder(df_plot$schedule_date, my(df_plot$schedule_date))
df_plot$month_cov <- format(df_plot$month_cov, format = "%b-%Y")

plot_ly(
  df_plot, x = ~n_month_delay, y = ~cov, color = ~schedule_date,
  type = "scatter", mode = "lines",
  hovertext = paste0("Schedule date: ", df_plot$schedule_date, "<br>",
                     "Cutoff month: ", df_plot$month_cov, "<br>",
                     "No. months delayed from schedule: ", df_plot$n_month_delay, "<br>",
                     "Coverage: ", df_plot$cov),
  hoverinfo = "text") %>%
  layout(
    xaxis = list(
      range = c(min(df_plot$n_month_delay) - 1, max(df_plot$n_month_delay) + 1),
      title = "Number of months delayed from schedule (months)"
    ),
    yaxis = list(
      range = c(0, max(df_plot$cov) + 0.1),
      title = "Vaccine coverage"
    ),
    legend = list(
      title = list(text = "Schedule")
    )
  )
```

### 2020

```{r}
# Set year
yr <- 2020

df_plot <- df_cov[which(year(df_cov$schedule_date) == yr),]

# Format df_plot for plot display
df_plot$schedule_date <- format(df_plot$schedule_date, format = "%b-%Y")
df_plot$schedule_date <- reorder(df_plot$schedule_date, my(df_plot$schedule_date))
df_plot$month_cov <- format(df_plot$month_cov, format = "%b-%Y")

plot_ly(
  df_plot, x = ~n_month_delay, y = ~cov, color = ~schedule_date,
  type = "scatter", mode = "lines",
  hovertext = paste0("Schedule date: ", df_plot$schedule_date, "<br>",
                     "Cutoff month: ", df_plot$month_cov, "<br>",
                     "No. months delayed from schedule: ", df_plot$n_month_delay, "<br>",
                     "Coverage: ", df_plot$cov),
  hoverinfo = "text") %>%
  layout(
    xaxis = list(
      range = c(min(df_plot$n_month_delay) - 1, max(df_plot$n_month_delay) + 1),
      title = "Number of months delayed from schedule (months)"
    ),
    yaxis = list(
      range = c(0, max(df_plot$cov) + 0.1),
      title = "Vaccine coverage"
    ),
    legend = list(
      title = list(text = "Schedule")
    )
  )
```

### 2021

```{r}
# Set year
yr <- 2021

df_plot <- df_cov[which(year(df_cov$schedule_date) == yr),]

# Format df_plot for plot display
df_plot$schedule_date <- format(df_plot$schedule_date, format = "%b-%Y")
df_plot$schedule_date <- reorder(df_plot$schedule_date, my(df_plot$schedule_date))
df_plot$month_cov <- format(df_plot$month_cov, format = "%b-%Y")

plot_ly(
  df_plot, x = ~n_month_delay, y = ~cov, color = ~schedule_date,
  type = "scatter", mode = "lines",
  hovertext = paste0("Schedule date: ", df_plot$schedule_date, "<br>",
                     "Cutoff month: ", df_plot$month_cov, "<br>",
                     "No. months delayed from schedule: ", df_plot$n_month_delay, "<br>",
                     "Coverage: ", df_plot$cov),
  hoverinfo = "text") %>%
  layout(
    xaxis = list(
      range = c(min(df_plot$n_month_delay) - 1, max(df_plot$n_month_delay) + 1),
      title = "Number of months delayed from schedule (months)"
    ),
    yaxis = list(
      range = c(0, max(df_plot$cov) + 0.1),
      title = "Vaccine coverage"
    ),
    legend = list(
      title = list(text = "Schedule")
    )
  )
```

### Compare cohorts between years

```{r}
m_delays <- c(0, 1, 2, 4, 6, 8)

df_plot <- df_cov %>% filter(n_month_delay %in% m_delays)

# Format to display month as Jan, Feb
df_plot$schedule_month <- format(df_plot$schedule_date, format = "%b")
# Set correct order (J > F > M > A...)
df_plot$schedule_month <- factor(df_plot$schedule_month, levels = month.abb)

df_plot$schedule_year <- format(df_plot$schedule_date, format = "%Y")
df_plot$schedule_year <- factor(df_plot$schedule_year)

ggplot(df_plot, aes(x = schedule_month, y = cov, group = schedule_year)) +
  geom_point(aes(shape = schedule_year, color = schedule_year)) +
  ylim(0, 1.2) +
  scale_x_discrete(label = function(x) abbreviate(x, minlength = 1, strict = T)) +
  facet_wrap(~ n_month_delay) +
  theme_light()
```

```{r}
m_delays <- c(0, 1, 2, 4, 6, 8)

df_plot <- df_cov %>% filter(n_month_delay %in% m_delays)

# Format to display month as Jan, Feb
df_plot$birth_month <- format(df_plot$cohort, format = "%b")
# Set correct order (J > F > M > A...)
df_plot$birth_month <- factor(df_plot$birth_month, levels = month.abb)

df_plot$birth_year <- format(df_plot$cohort, format = "%Y")
df_plot$birth_year <- factor(df_plot$birth_year)

ggplot(df_plot, aes(x = birth_month, y = cov, group = birth_year)) +
  geom_point(aes(shape = birth_year, color = birth_year)) +
  ylim(0, 1.2) +
  scale_x_discrete(label = function(x) abbreviate(x, minlength = 1, strict = T)) +
  facet_wrap(~ n_month_delay) +
  theme_light()
```

# Measles and COVID-19 vaccination per month

```{r}
covidvc <- covidvc[which(covidvc$location == pv_name),]
covidvc$total_shots <- rowSums(covidvc[,c("vaccinated_1st", "vaccinated_2nd", "vaccinated_3rd")], na.rm = T)

covidvc$vacym <- floor_date(covidvc$date, time_step)
covidvc$vacyear <- year(covidvc$vacym)
covidvc$vacmonth <- month(covidvc$vacym)

covid <- covidvc %>% 
  group_by(vacyear, vacmonth) %>%
  summarise(n = sum(total_shots))

covid$vacname <- "COVID vaccine"
covid$n <- covid$n / 50

df_plot <- measles_all %>% 
    count(vacyear, vacmonth, vacname)

df_plot <- rbind(df_plot, covid)

ggplot(df_plot, aes(x = vacmonth, y = n, color = vacname)) +
  geom_line(stat = "identity") +
  facet_wrap(~ vacyear) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 6)) +
  labs(x = NULL) +
  theme_light()
```
* High peak of MR shots in Nov 2019
* No disruption in Apr 2020
* Disruptions in Aug 2020 and Feb 2021

# Vaccination campaign in Nov 2019

An MR vaccination campaign is triggered during this time in Hai Duong, focusing on children 1-5 year-old
```{r}
tmp_year <- 2019
tmp <- measles_all[which(measles_all$vacyear == tmp_year),]

ggplot(tmp, aes(x = vagem)) +
  geom_histogram() +
  facet_wrap(~ vacmonth, scales = "free") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5)) +
  labs(x = "Age at vaccination (months)") +
  ggtitle(tmp_year)
```
# No disruption in Apr 2020 but in Aug 2020 and Feb 2021

The monthly vaccination date at public clinics is usually at the end of the month. In Mar 2020: right before lockdown they vaccinate children and right after lockdown they came back to vaccinate children

Hai Duong had a Hai Duong city-wide lockdown from 14/8-28/8, this time looks like they only organised the vaccination day in Sep so all children scheduled in Aug miss the shot
```{r}
tmp_vacyear <- 2019
tmp <- measles_all[which(measles_all$vacyear == tmp_vacyear),]

df_plot <- tmp %>% 
    count(vacdate, vacname)

# write.csv(df_plot, file.path(dtoutp, "measles_shots_2020.csv"), quote = F, row.names = F)

ggplot(df_plot, aes(x = vacdate, y = n, color = vacname)) +
  # geom_rect(aes(xmin = ymd("2020-04-01"), xmax = ymd("2020-04-21"), ymin = -Inf, ymax = Inf), fill = "grey90", color = NA, alpha = 0.3) +
  # geom_rect(aes(xmin = ymd("2020-08-14"), xmax = ymd("2020-08-28"), ymin = -Inf, ymax = Inf), fill = "grey90", color = NA, alpha = 0.3) +
  geom_line(stat = "identity") +
  scale_x_date(date_breaks = "1 month", labels = scales::date_format("%b")) +
  labs(x = NULL, color = "Vaccine") +
  theme_light() +
  ggtitle(paste0("Hai Duong - ", tmp_vacyear))
ggsave("~/figs/haiduong19.pdf", width = 5.5, height = 3)
```

## Zoom in 2021

Hai Duong had a province-wide lockdown from 28/1/2021 - 15/2 (Directive 15), 16/2 - 2/3 (Directive 16), 3/3 - 17/3 (Directive 15), 18/3 - 31/3 (Directive 19)

Directive 16 > 15 > 19
```{r}
tmp_vacyear <- 2021
tmp <- measles_all[which(measles_all$vacyear == tmp_vacyear),]

df_plot <- tmp %>% 
    count(vacdate, vacname)

# write.csv(df_plot, file.path(dtoutp, "measles_shots_2021.csv"), quote = F, row.names = F)

ggplot(df_plot, aes(x = vacdate, y = n, color = vacname)) +
  geom_rect(aes(xmin = ymd("2021-01-28"), xmax = ymd("2021-02-15"), ymin = -Inf, ymax = Inf), fill = "grey90", color = NA, alpha = 0.5) +
  geom_rect(aes(xmin = ymd("2021-02-16"), xmax = ymd("2021-03-02"), ymin = -Inf, ymax = Inf), fill = "grey90", color = NA, alpha = 0.5) +
  geom_rect(aes(xmin = ymd("2021-03-03"), xmax = ymd("2021-03-17"), ymin = -Inf, ymax = Inf), fill = "grey90", color = NA, alpha = 0.5) +
  geom_rect(aes(xmin = ymd("2021-03-18"), xmax = ymd("2021-03-31"), ymin = -Inf, ymax = Inf), fill = "wheat", color = NA, alpha = 0.5) +
  geom_line(stat = "identity") +
  scale_x_date(date_breaks = "1 month", labels = scales::date_format("%b")) +
  labs(x = NULL, color = "Vaccine") +
  theme_light() +
  ggtitle(paste0("Hai Duong - ", tmp_vacyear))
ggsave("~/figs/haiduong21.pdf", width = 5.5, height = 3)
```

# Public vs private

First let decide how a shot is public or private

```{r}
table(measles_all$clinic_type)
measles_all$type2 <- ifelse(
  measles_all$clinic_type %in% c("unknown", "other"),
  measles_all$vactype, 
  ifelse(
    measles_all$clinic_type == "hospital",
    "private", 
    measles_all$clinic_type
  )
)
measles_all$type2 <- ifelse(measles_all$type2 == "campaign", "public", measles_all$type2)
# table(measles_all$type2)
```

Extract children who get 2 shots

```{r}
measles_2shots <- measles_all[duplicated(measles_all$pid) | duplicated(measles_all$pid, fromLast = T),]

dup_sameday <- measles_2shots[duplicated(measles_2shots[,c("pid", "vacdate")]) |
                                duplicated(measles_2shots[,c("pid", "vacdate")], fromLast = T),
                              c("pid", "vacdate", "vacname", "type2")]
dup_sameday <- dup_sameday[order(dup_sameday$pid),]
# head(dup_sameday, 10)
```

Some received the same vaccine in the same day, filter them out and continue

```{r}
# Remove children with multiple shots of measles in the same day
measles_2shots <- measles_2shots %>%
  distinct(., pid, vacdate, .keep_all = T)

# Now subset the one still get 2 shots
measles_2shots <- measles_2shots[duplicated(measles_2shots$pid) | duplicated(measles_2shots$pid, fromLast = T),]

# Sort by vaccination date and numbering the shot
measles_2shots <- measles_2shots %>%
  group_by(pid) %>%
  arrange(vacdate) %>%
  mutate(vtimes = 1:n(),
         vacdate_1st = first(vacdate)) %>%
  ungroup()

# How many shots they receive
# table(measles_2shots$vtimes)
```

Some received 3 shots, filtered them out.

```{r}
# Remove those who get the 3rd shot
measles_2shots <- measles_2shots[measles_2shots$vtimes != 3,]
measles_2shots <- measles_2shots[order(measles_2shots$pid),]

# Prefix "shot" to vtimes to make wide data frame easier
measles_2shots$vtimes <- paste0("shot", measles_2shots$vtimes)
```

Change dataset from long to wide format
```{r}
df <- measles_2shots[, c("pid", "vacdate_1st", "vtimes", "type2")]
df <- df %>%
  pivot_wider(., names_from = vtimes, values_from = type2)

df$vyear_1st <- year(df$vacdate_1st)
df$vmonth_1st <- month(df$vacdate_1st)

# head(df)
```

Aggregate them by month

```{r, warning=FALSE}
df_type <- aggregate(pid ~ vyear_1st + vmonth_1st + shot1 + shot2, data = df, FUN = length)

df_type <- df_type %>%
  group_by(vyear_1st, vmonth_1st, shot1) %>%
  mutate(denom = sum(pid))

df_type$pct2 <- 100 * df_type$pid / df_type$denom

res <- t(apply(df_type[,c("pid", "denom")], 1, FUN = function(x) {
  rr <- binom.test(x[1], x[2])
  with(rr, c(x, 
             "low_ci" = 100 * conf.int[1],
             "high_ci" = 100 * conf.int[2]))
}))

res <- cbind(res, df_type[,grep("pid|denom", colnames(df_type), invert = T)])

# Take 01/2018 as an example
# df_type %>%
#   filter(vyear_1st == 2018 & vmonth_1st == 1) %>%
#   print()
```

Line plot

```{r}
# Get only row that 2nd shot is private
df_plot <- res[res$shot2 == "private",]

# To plot on a date format x-axis
df_plot$vacdate_1st <- ym(paste0(df_plot$vyear_1st, "-", df_plot$vmonth_1st))

# Subset from 09/2017 to 03/2020
df_plot <- df_plot[df_plot$vacdate_1st >= "2018-01-01" &
                     df_plot$vacdate_1st <= "2021-11-01",]

df_plot$shot1 <- factor(df_plot$shot1, levels = c("public", "private"))

# write.csv(df_plot, file.path(dtoutp, "switch_private_2shots.csv"), quote = F, row.names = F)

ggplot(df_plot, aes(x = vacdate_1st, y = pct2, group = shot1)) +
  geom_line(aes(linetype = shot1), stat = "identity", size = 1.1) +
  geom_ribbon(aes(ymin = low_ci, ymax = high_ci, fill = shot1), alpha = 0.25) +
  # geom_vline(xintercept=as.numeric(as.Date("2019-07-01")), color = "orange") +
  scale_x_date(date_labels = "%b-%Y", date_breaks = "3 months") +
  ylim(c(0, 100)) +
  theme_minimal() +
  labs(x = "Month of receiving 1st dose", y = "% 2nd dose in private", linetype = "1st dose in", fill = "1st dose in") +
  theme(axis.text.x = element_text(angle = -45, hjust = -0.1),
        panel.grid.minor.x = element_blank())
ggsave("~/figs/haiduong_switch.pdf", width = 5, height = 3)
```


```{r}
tmp <- df_plot[df_plot$vacdate_1st %in% as.Date(c("2020-01-01", "2020-08-01", "2021-02-01")),]
tmp[order(tmp$vacdate_1st),]
```

```{r}
tmp <- df_plot[df_plot$vacdate_1st >= "2021-03-01",]
tmp[order(tmp$vacdate_1st),]
```

# Population level

```{r}
df <- measles_all[, c("pid", "province", "vacyear", "vacmonth", "type2")]
df_type <- aggregate(pid ~ vacyear + vacmonth + type2, data = df, FUN = length)

# Percentage of private
df_type <- df_type %>%
  group_by(vacyear, vacmonth) %>%
  mutate(denom = sum(pid))

df_type$pct <- 100 * df_type$pid / df_type$denom

# Get only row that 2nd shot is private
df_plot <- df_type[df_type$type2 == "private",]

# To plot on a date format x-axis
df_plot$vacdate <- ym(paste0(df_plot$vacyear, "-", df_plot$vacmonth))
df_plot <- df_plot[df_plot$vacdate >= "2017-09-01",]

write.csv(df_plot, file.path(dtoutp, "switch_private_poplevel.csv"), quote = F, row.names = F)

ggplot(df_plot, aes(x = vacdate, y = pct)) +
  geom_line(stat = "identity") +
  # geom_vline(xintercept=as.numeric(as.Date("2020-04-01")), color = "orange") +
  labs(y = "Percentage of private shot (%)", x = "Month of receiving shot") +
  theme_minimal()
```

# Children who got 2 shots

```{r}
ggplot(measles_2shots, aes(x = vdelay)) +
  geom_histogram() +
  facet_wrap(~ vacname, scales = "free")
```

# Age at vaccination distribution

## Measles

Use full data

```{r}
measles <- measles_all[which(measles_all$vacname == "Measles" & measles_all$skd_year %in% c(2019, 2020)), c("vagem", "skd_month", "skd_year")]
measles$skd_year <- factor(measles$skd_year)

ggplot(measles, aes(x = vagem, fill = skd_year)) + 
  geom_density(alpha = 0.5) +
  facet_wrap(~ skd_month, scales = "free") +
  labs(x = "Age at vaccination (months)", y = "Density", fill = "Vaccination year")

# Kullback-Leibler divergence with seewave
# https://rug.mnhn.fr/seewave/HTML/MAN/kl.dist.html
months_list <- 1:12
kl <- numeric(12)
ks <- numeric(12)
for (im in months_list) {
  
  tmp <- measles$vagem[measles$skd_year == 2019 & measles$skd_month == im]
  tmp <- density(tmp)
  tmp <- data.frame(tmp[1:2])
  d19 <- matrix(c(tmp$x, tmp$y), ncol = 2, dimnames = list(NULL, c("x", "y")))
  
  tmp <- measles$vagem[measles$skd_year == 2020 & measles$skd_month == im]
  tmp <- density(tmp)
  tmp <- data.frame(tmp[1:2])
  d20 <- matrix(c(tmp$x, tmp$y), ncol = 2, dimnames = list(NULL, c("x", "y")))
  
  kl[im] <- kl.dist(d19, d20)$D
  ks[im] <- ks.test(d19[,2], d20[,2])
}

df_plot <- data.frame(month = factor(months_list), divergence = kl)

ggplot(df_plot, aes(x = month, y = divergence)) +
  geom_bar(stat = "identity")
```

Only children vaccinated from 8-16 months

```{r, echo = T}
measles <- measles_all[which(measles_all$vacname == "Measles" & measles_all$skd_year %in% c(2019, 2020) & measles_all$vagem >= 8 & measles_all$vagem <= 16), c("vagem", "skd_month", "skd_year")]
measles$skd_year <- factor(measles$skd_year)

ggplot(measles, aes(x = vagem, fill = skd_year)) + 
  geom_density(alpha = 0.5) +
  facet_wrap(~ skd_month, scales = "free") +
  labs(x = "Age at vaccination (months)", y = "Density", fill = "Schedule") +
  theme_minimal()

ggplot(measles, aes(x = vagem, fill = skd_year)) + 
  geom_histogram(aes(y = ..density..), alpha = 0.5, color = "grey40", position = "identity") +
  facet_wrap(~ skd_month, scales = "free") +
  labs(x = "Age at vaccination (months)", fill = "Schedule") +
  theme_minimal()
  
# Kullback-Leibler divergence with seewave
# https://rug.mnhn.fr/seewave/HTML/MAN/kl.dist.html
months_list <- 1:12
kl <- numeric(12)
ks <- numeric(12)
for (im in months_list) {
  
  tmp <- measles$vagem[measles$skd_year == 2019 & measles$skd_month == im]
  tmp <- density(tmp)
  tmp <- data.frame(tmp[1:2])
  d19 <- matrix(c(tmp$x, tmp$y), ncol = 2, dimnames = list(NULL, c("x", "y")))
  
  tmp <- measles$vagem[measles$skd_year == 2020 & measles$skd_month == im]
  tmp <- density(tmp)
  tmp <- data.frame(tmp[1:2])
  d20 <- matrix(c(tmp$x, tmp$y), ncol = 2, dimnames = list(NULL, c("x", "y")))
  
  kl[im] <- kl.dist(d19, d20)$D
  ks[im] <- ks.test(measles$vagem[measles$skd_year == 2019 & measles$skd_month == im], 
                    measles$vagem[measles$skd_year == 2020 & measles$skd_month == im],
                    simulate.p.value = T)$p.value
}

df_plot <- data.frame(month = factor(months_list), divergence = kl, pval = ks)

ggplot(df_plot, aes(x = month, y = divergence)) +
  geom_bar(stat = "identity") +
  geom_point(aes(y = pval))
```

## MR

```{r}
measles <- measles_all[which(measles_all$vacname == "MR" & measles_all$skd_year %in% c(2019, 2020) & measles_all$vagem >= 16 & measles_all$vagem <= 28), c("vagem", "skd_month", "skd_year")]
measles$skd_year <- factor(measles$skd_year)

ggplot(measles, aes(x = vagem, fill = skd_year)) + 
  geom_density(alpha = 0.5) +
  facet_wrap(~ skd_month, scales = "free") +
  labs(x = "Age at vaccination (months)", y = "Density", fill = "Schedule")

# Kullback-Leibler divergence with seewave
# https://rug.mnhn.fr/seewave/HTML/MAN/kl.dist.html
months_list <- 1:12
kl <- numeric(12)
for (im in months_list) {
  
  tmp <- measles$vagem[measles$skd_year == 2019 & measles$skd_month == im]
  tmp <- density(tmp)
  tmp <- data.frame(tmp[1:2])
  d19 <- matrix(c(tmp$x, tmp$y), ncol = 2, dimnames = list(NULL, c("x", "y")))
  
  tmp <- measles$vagem[measles$skd_year == 2020 & measles$skd_month == im]
  tmp <- density(tmp)
  tmp <- data.frame(tmp[1:2])
  d20 <- matrix(c(tmp$x, tmp$y), ncol = 2, dimnames = list(NULL, c("x", "y")))
  
  kl[im] <- kl.dist(d19, d20)$D
}

df_plot <- data.frame(month = factor(months_list), divergence = kl)

ggplot(df_plot, aes(x = month, y = divergence)) +
  geom_bar(stat = "identity")
```

